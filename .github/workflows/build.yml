# CI/CD Workflow
name: Yocto PREEMPT_RT Build

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main

jobs:
  build:
    # Use Ubuntu 22.04 runner because ubuntu-24.04 disables unprivileged user namespaces
    # by default which prevents BitBake from using user namespaces (AppArmor-related).
    # See: https://discourse.ubuntu.com/t/ubuntu-24-04-lts-noble-numbat-release-notes/39890
    runs-on: [self-hosted, linux, ubuntu-24.04]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gawk wget git-core diffstat unzip texinfo gcc-multilib \
          build-essential chrpath socat cpio python3 python3-pip python3-pexpect xz-utils \
          python3-venv \
          debianutils iputils-ping libsdl1.2-dev xterm autoconf libtool libglib2.0-dev \
          libarchive-dev bc u-boot-tools libncurses5-dev libncursesw5-dev zstd liblz4-tool \
          libssl-dev flex bison python3-jinja2 \
          python3-subunit mesa-common-dev zstd python3-yaml python3-distro
          # Create an isolated virtual environment for Python tools (avoids
          # PEP 668 'externally-managed-environment' restrictions) and install kas there.
          python3 -m venv .venv
          # Activate and upgrade pip inside the venv, then install kas.
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install kas
          # Add the venv bin to the job PATH so subsequent steps can run kas
          echo "${GITHUB_WORKSPACE}/.venv/bin" >> $GITHUB_PATH
      - name: Build Yocto Image
        run: |
          kas build kas/firmware.yml
